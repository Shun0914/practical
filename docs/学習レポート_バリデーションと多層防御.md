# Week20 å®Ÿè·µèª²é¡Œ å­¦ç¿’ãƒ¬ãƒãƒ¼ãƒˆ

**ä½œæˆæ—¥**: 2025å¹´11æœˆ2æ—¥  
**ãƒ†ãƒ¼ãƒ**: FastAPI + Next.js CRMã‚·ã‚¹ãƒ†ãƒ ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨å¤šå±¤é˜²å¾¡

---

## ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**: FastAPI + SQLAlchemy + SQLite
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: Next.js (App Router) + Tailwind CSS
- **æ©Ÿèƒ½**: é¡§å®¢ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  (CRUDæ“ä½œ)

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ 
- `customers`: é¡§å®¢æƒ…å ± (customer_id, customer_name, age, gender)
- `items`: å•†å“æƒ…å ±
- `purchases`: è³¼å…¥å±¥æ­´
- `purchase_details`: è³¼å…¥è©³ç´°

---

## ğŸ› èª²é¡Œ1: UPDATEæ©Ÿèƒ½ã®ãƒã‚°ä¿®æ­£

### å•é¡Œ
`crud.py`ã®`myupdate`é–¢æ•°ã«æ„å›³çš„ãªãƒã‚°ãŒä»•è¾¼ã¾ã‚Œã¦ã„ãŸã€‚

```python
query = "ãŠè¦‹äº‹ï¼E0002ã®åŸå› ã¯ã“ã®ã‚¯ã‚¨ãƒªã®å®Ÿè£…ãƒŸã‚¹ã§ã™ã€‚æ­£ã—ãå®Ÿè£…ã—ã¾ã—ã‚‡ã†"
```

### ã‚¨ãƒ©ãƒ¼å†…å®¹
```
sqlalchemy.exc.ArgumentError: Textual SQL expression 'ãŠè¦‹äº‹ï¼...' 
should be explicitly declared as text('...')
```

### åŸå› 
- SQLAlchemyã¯æ–‡å­—åˆ—ã‚’ãã®ã¾ã¾SQLã¨ã—ã¦å®Ÿè¡Œã—ã‚ˆã†ã¨ã—ãŸ
- æ­£ã—ã„ã‚¯ã‚¨ãƒªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ãªãã€æ–‡å­—åˆ—ãŒæ¸¡ã•ã‚Œã¦ã„ãŸ

### è§£æ±ºç­–
ä»–ã®é–¢æ•°(`mydelete`, `myinsert`)ã‚’å‚è€ƒã«ã€æ­£ã—ã„`update()`ã‚¯ã‚¨ãƒªã‚’å®Ÿè£…:

```python
def myupdate(mymodel, values):
    Session = sessionmaker(bind=engine)
    session = Session()

    customer_id = values.pop("customer_id")

    # æ­£ã—ã„ã‚¯ã‚¨ãƒªå®Ÿè£…
    query = update(mymodel).where(
        mymodel.customer_id == customer_id
    ).values(values)
    
    try:
        with session.begin():
            result = session.execute(query)
    except sqlalchemy.exc.IntegrityError:
        print("ä¸€æ„åˆ¶ç´„é•åã«ã‚ˆã‚Šã€æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ")
        session.rollback()
    
    session.close()
    return "updated"
```

### å­¦ã³
- `.values(values)` ã¯å¿…é ˆ: UPDATEæ–‡ã®`SET`å¥ã«ç›¸å½“
- `values` è¾æ›¸ãŒç©ºã ã¨ `UPDATE customers SET WHERE ...` ã¨ãªã‚Šã‚¨ãƒ©ãƒ¼

---

## ğŸ”’ èª²é¡Œ2: ç©ºIDãƒ‡ãƒ¼ã‚¿ã®ä½œæˆé˜²æ­¢

### å•é¡Œ
> ã€ŒidãŒç©ºç™½ï¼ˆnullï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã§ãã¦ã—ã¾ã„ã€å½“è©²ãƒ‡ãƒ¼ã‚¿ã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä»•æ§˜ä¸ŠCRUDæ“ä½œãŒã§ããªããªã£ã¦ã—ã¾ã†ã€‚ã“ã®ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿ãŒç™ºç”Ÿã—ã¦ã—ã¾ã‚ãªã„ã‚ˆã†ãªæ’ä¹…å¯¾ç­–ã‚’è¬›ã˜ã¦ãã ã•ã„ã€‚ã€

### åˆæœŸã‚¨ãƒ©ãƒ¼
```
[TypeError: Failed to parse URL from undefined/customers]
input: 'undefined/customers'
```

**åŸå› **: ç’°å¢ƒå¤‰æ•° `NEXT_PUBLIC_API_ENDPOINT` ãŒæœªè¨­å®š

### è§£æ±º1: ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
`frontend/.env.local` ã‚’ä½œæˆ:
```bash
NEXT_PUBLIC_API_ENDPOINT=http://localhost:8000
```

---

## ğŸ’¡ é‡è¦ãªæ¦‚å¿µ: NULL vs ç©ºæ–‡å­—

### NULL
- **æ„å‘³**: ã€Œå€¤ãŒå­˜åœ¨ã—ãªã„ã€ã€Œæœªå®šç¾©ã€
- **ä¾‹**: `None` (Python), `null` (JavaScript), `NULL` (SQL)
- **çŠ¶æ…‹**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸Šã€å€¤ãŒå…¥ã£ã¦ã„ãªã„

### ç©ºæ–‡å­— `""`
- **æ„å‘³**: ã€Œå€¤ã¯å­˜åœ¨ã™ã‚‹ãŒã€ä¸­èº«ãŒç©ºã€
- **ä¾‹**: `""` (Python/JavaScript/SQL)
- **çŠ¶æ…‹**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸Šã€æ–‡å­—åˆ—å‹ã®å€¤ãŒå…¥ã£ã¦ã„ã‚‹(é•·ã•0)

### å…·ä½“ä¾‹
```python
# NULL: å›ç­”ã—ã¦ã„ãªã„
{"customer_id": None}

# ç©ºæ–‡å­—: æ„å›³çš„ã«ç©ºç™½ã§å›ç­”
{"customer_id": ""}

# æ­£å¸¸: ã¡ã‚ƒã‚“ã¨å…¥åŠ›
{"customer_id": "C1234"}
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã®æŒ™å‹•
```sql
-- NULL ãƒã‚§ãƒƒã‚¯
WHERE name IS NULL      âœ… NULLã‚’è¦‹ã¤ã‘ã‚‹
WHERE name = NULL       âŒ å‹•ã‹ãªã„!

-- ç©ºæ–‡å­—ãƒã‚§ãƒƒã‚¯  
WHERE name = ''         âœ… ç©ºæ–‡å­—ã‚’è¦‹ã¤ã‘ã‚‹
WHERE name IS NULL      âŒ ç©ºæ–‡å­—ã¯è¦‹ã¤ã‹ã‚‰ãªã„
```

---

## ğŸ›¡ï¸ å¤šå±¤é˜²å¾¡ã®å®Ÿè£…

### ãƒ¬ã‚¤ãƒ¤ãƒ¼1: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (UXå‘ä¸Š)

**ç›®çš„**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å³åº§ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯

```javascript
// frontend/src/app/customers/create/page.jsx
const handleSubmit = async (event) => {
    event.preventDefault();
    const formData = new FormData(formRef.current);
    
    const customerId = formData.get("customer_id");
    
    // IDãŒç©ºãªã‚‰é€ä¿¡ã—ãªã„
    if (!customerId) { 
        alert("IDã¯å¿…é ˆã§ã™"); 
        return; 
    }
    
    await createCustomer(formData);
    router.push(`./create/confirm?customer_id=${customerId}`);
};
```

**ãƒ¡ãƒªãƒƒãƒˆ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå³åº§ã«ã‚¨ãƒ©ãƒ¼ã«æ°—ã¥ã‘ã‚‹  
**å¼±ç‚¹**: JavaScriptã‚’ç„¡åŠ¹åŒ–ã•ã‚ŒãŸã‚Šã€ç›´æ¥APIã‚’å©ã‹ã‚ŒãŸã‚‰çªç ´ã•ã‚Œã‚‹

---

### ãƒ¬ã‚¤ãƒ¤ãƒ¼2: FastAPI (Pydantic) [ã‚ªãƒ—ã‚·ãƒ§ãƒ³]

**ç›®çš„**: APIå±¤ã§ã®æ¤œè¨¼ã€‚ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’çµŒç”±ã—ãªã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚‚é˜²ã

```python
# backend/app.py
from pydantic import BaseModel, field_validator

class Customer(BaseModel):
    customer_id: str
    customer_name: str
    age: int
    gender: str

    @field_validator('customer_id')
    def validate_customer_id(cls, v):
        if not v or v.strip() == '':
            raise ValueError('customer_idã¯ç©ºã«ã§ãã¾ã›ã‚“')
        return v
```

**ãƒ¡ãƒªãƒƒãƒˆ**: 
- ç›´æ¥APIæ”»æ’ƒã‚’é˜²ã’ã‚‹
- è¦ªåˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã›ã‚‹ (`422 Unprocessable Entity`)

**å¼±ç‚¹**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚ŒãŸã‚‰ç„¡æ„å‘³

---

### ãƒ¬ã‚¤ãƒ¤ãƒ¼3: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (æœ€çµ‚é˜²è¡›ç·š) [å¿…é ˆ]

**ç›®çš„**: ã©ã‚“ãªçµŒè·¯ã§ã‚‚çµ¶å¯¾ã«ç©ºãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã•ã›ãªã„

```python
# backend/db_control/mymodels.py
class Customers(Base):
    __tablename__ = 'customers'
    
    # nullable=False ã§çµ¶å¯¾ã®æŸã‚’åˆ»ã‚€
    customer_id: Mapped[str] = mapped_column(primary_key=True, nullable=False)
    customer_name: Mapped[str] = mapped_column()
    age: Mapped[int] = mapped_column()
    gender: Mapped[str] = mapped_column()
```

**æ³¨æ„**: 
- `primary_key=True` ã®æ™‚ç‚¹ã§è‡ªå‹•çš„ã« `nullable=False` ãŒè¨­å®šã•ã‚Œã‚‹
- ã—ã‹ã—ã€**æ˜ç¤ºçš„ã«æ›¸ãã“ã¨ãŒãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹**(ã‚³ãƒ¼ãƒ‰ã®æ„å›³ãŒæ˜ç¢ºã«ãªã‚‹)

**ãƒ¡ãƒªãƒƒãƒˆ**: **ç‰©ç†çš„ã«ä¸å¯èƒ½ã«ã™ã‚‹**  
**å¼±ç‚¹**: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæŠ€è¡“çš„ã™ãã‚‹

---

## ğŸ¯ ã€Œãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’çµŒç”±ã—ãªã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ã¨ã¯?

### é€šå¸¸ã®æµã‚Œ
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ ãƒ–ãƒ©ã‚¦ã‚¶(Next.js) â†’ FastAPI â†’ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
         â†‘
    ã“ã“ã§JavaScriptã®ãƒã‚§ãƒƒã‚¯ãŒåƒã
```

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹æ–¹æ³•

#### 1. ç›´æ¥APIã‚’å©ã
```bash
curl -X POST http://localhost:8000/customers \
  -H "Content-Type: application/json" \
  -d '{"customer_id": "", "customer_name": "æ‚ªæ„ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼", "age": 30, "gender": "ç”·"}'
```

#### 2. ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§æ”¹ã–ã‚“
```javascript
fetch('http://localhost:8000/customers', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    customer_id: '',  // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚’ç„¡è¦–
    customer_name: 'æ”¹ã–ã‚“ãƒ‡ãƒ¼ã‚¿',
    age: 30,
    gender: 'ç”·'
  })
})
```

#### 3. æ‚ªæ„ã‚ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```python
import requests

requests.post('http://localhost:8000/customers', json={
    'customer_id': '',
    'customer_name': 'ãƒœãƒƒãƒˆ',
    'age': 30,
    'gender': 'ç”·'
})
```

---

## ğŸ“Š å¤šå±¤é˜²å¾¡ã¾ã¨ã‚

| é˜²å¾¡å±¤ | å¿…é ˆ? | å½¹å‰² | é˜²ã’ã‚‹æ”»æ’ƒ |
|--------|------|------|-----------|
| **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰** | â—‹ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Š | æ™®é€šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒŸã‚¹ |
| **FastAPI (Pydantic)** | â–³ | APIä¿è­·(ã‚ã‚Œã°ãƒ™ã‚¿ãƒ¼) | ç›´æ¥APIæ”»æ’ƒã€æ”¹ã–ã‚“ |
| **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹** | â— | æœ€çµ‚é˜²è¡›ç·š(çµ¶å¯¾å¿…è¦) | ã™ã¹ã¦ã®æ”»æ’ƒ |

---

## ğŸ“ é‡è¦ãªå­¦ã³

### 1. Webé–‹ç™ºã®é‰„å‰‡
**ã€Œãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã¯ä¿¡ç”¨ã§ããªã„ã€**

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å¿…ãšã—ã‚‚æ­£ç›´ã§ã¯ãªã„
- ãƒ–ãƒ©ã‚¦ã‚¶ã®JavaScriptã¯ç„¡åŠ¹åŒ–ãƒ»æ”¹ã–ã‚“å¯èƒ½
- APIã¯å¸¸ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹

### 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®åŸºæœ¬
- **æ±ºã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã ã‘ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã—ãªã„**
- **ã‚µãƒ¼ãƒãƒ¼å´ã§å¿…ãšæ¤œè¨¼ã™ã‚‹**
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ¶ç´„ã§æœ€çµ‚é˜²è¡›ç·šã‚’å¼µã‚‹**

### 3. SQLAlchemyã®ã‚¯ã‚¨ãƒªæ§‹ç¯‰
```python
# âŒ é–“é•ã„
query = "UPDATE customers SET ..."

# âœ… æ­£ã—ã„
query = update(mymodel).where(...).values(...)
```

### 4. ã‚³ãƒ¼ãƒ‰ã®æ˜ç¤ºæ€§
```python
# âŒ å‹•ãã‘ã©æ›–æ˜§
customer_id: Mapped[str] = mapped_column(primary_key=True)

# âœ… æ˜ç¤ºçš„ã§åˆ†ã‹ã‚Šã‚„ã™ã„
customer_id: Mapped[str] = mapped_column(primary_key=True, nullable=False)
```

---

## ğŸ”§ å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [x] UPDATEæ©Ÿèƒ½ã®ä¿®æ­£ (`crud.py` ã® `myupdate` é–¢æ•°)
- [x] ç’°å¢ƒå¤‰æ•°ã®è¨­å®š (`.env.local`)
- [x] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ (JavaScript)
- [x] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ¶ç´„ (`nullable=False`)
- [ ] Pydanticãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€ã‚ˆã‚Šå …ç‰¢ã«ã—ãŸã„å ´åˆ)

---

## ğŸ’­ ä»Šå¾Œã®èª²é¡Œ

1. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®UIæ”¹å–„
2. ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰(customer_name, age, gender)ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
3. APIã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™å®Ÿè£…
4. ãƒ­ã‚®ãƒ³ã‚°ãƒ»ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã®è¿½åŠ 

---

## å‚è€ƒãƒªãƒ³ã‚¯

- [FastAPIå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://fastapi.tiangolo.com/)
- [SQLAlchemyå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.sqlalchemy.org/)
- [Pydanticå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.pydantic.dev/)
- [Next.jså…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://nextjs.org/docs)
